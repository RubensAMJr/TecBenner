!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e(require()):t.AceDiff=e()}(this,function(){"use strict";var t=require("ace/range").Range,e={DIFF_EQUAL:0,DIFF_DELETE:-1,DIFF_INSERT:1,EDITOR_RIGHT:"right",EDITOR_LEFT:"left",RTL:"rtl",LTR:"ltr",SVG_NS:"http://www.w3.org/2000/svg",DIFF_GRANULARITY_SPECIFIC:"specific",DIFF_GRANULARITY_BROAD:"broad"};function i(t){var i,s;this.options={},C(!0,this.options,{mode:null,theme:null,diffGranularity:e.DIFF_GRANULARITY_BROAD,lockScrolling:!1,showDiffs:!0,showConnectors:!0,maxDiffs:5e3,left:{id:"acediff-left-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},right:{id:"acediff-right-editor",content:null,mode:null,theme:null,editable:!0,copyLinkEnabled:!0},classes:{gutterID:"acediff-gutter",diff:"acediff-diff",connector:"acediff-connector",newCodeConnectorLink:"acediff-new-code-connector-copy",newCodeConnectorLinkContent:"&#8594;",deletedCodeConnectorLink:"acediff-deleted-code-connector-copy",deletedCodeConnectorLinkContent:"&#8592;",copyRightContainer:"acediff-copy-right",copyLeftContainer:"acediff-copy-left"},connectorYOffset:0},t),this.editors={left:{ace:ace.edit(this.options.left.id),markers:[],lineLengths:[]},right:{ace:ace.edit(this.options.right.id),markers:[],lineLengths:[]},editorHeight:null},function(t){var i,n=(new Date).getTime(),o=(new Date).getTime();t.editors.left.ace.getSession().on("changeScrollTop",function(e){i=(new Date).getTime(),o+50<i&&c(t,"left",e)}),t.editors.right.ace.getSession().on("changeScrollTop",function(e){i=(new Date).getTime(),n+50<i&&c(t,"right",e)});var s=t.diff.bind(t);t.editors.left.ace.on("change",s),t.editors.right.ace.on("change",s),t.options.left.copyLinkEnabled&&I("#"+t.options.classes.gutterID,"click","."+t.options.classes.newCodeConnectorLink,function(i){r(t,i,e.LTR)});t.options.right.copyLinkEnabled&&I("#"+t.options.classes.gutterID,"click","."+t.options.classes.deletedCodeConnectorLink,function(i){r(t,i,e.RTL)});var a=(l=function(){t.editors.availableHeight=document.getElementById(t.options.left.id).offsetHeight,t.diff()},f=250,function(){var t=this,e=arguments,i=d&&!h;clearTimeout(h),h=setTimeout(function(){h=null,d||l.apply(t,e)},f),i&&l.apply(t,e)});var l,f,d,h;window.addEventListener("resize",a)}(this),this.lineHeight=this.editors.left.ace.renderer.lineHeight,this.editors.left.ace.getSession().setMode(n(this,e.EDITOR_LEFT)),this.editors.right.ace.getSession().setMode(n(this,e.EDITOR_RIGHT)),this.editors.left.ace.setReadOnly(!this.options.left.editable),this.editors.right.ace.setReadOnly(!this.options.right.editable),this.editors.left.ace.setTheme(o(this,e.EDITOR_LEFT)),this.editors.right.ace.setTheme(o(this,e.EDITOR_RIGHT)),(i=this).copyRightContainer=document.createElement("div"),i.copyRightContainer.setAttribute("class",i.options.classes.copyRightContainer),i.copyLeftContainer=document.createElement("div"),i.copyLeftContainer.setAttribute("class",i.options.classes.copyLeftContainer),document.getElementById(i.options.classes.gutterID).appendChild(i.copyRightContainer),document.getElementById(i.options.classes.gutterID).appendChild(i.copyLeftContainer),E(this),this.options.left.content&&this.editors.left.ace.setValue(this.options.left.content,-1),this.options.right.content&&this.editors.right.ace.setValue(this.options.right.content,-1),this.editors.editorHeight=(s=this,document.getElementById(s.options.left.id).offsetHeight),this.diff()}function n(t,i){var n=t.options.mode;return i===e.EDITOR_LEFT&&null!==t.options.left.mode&&(n=t.options.left.mode),i===e.EDITOR_RIGHT&&null!==t.options.right.mode&&(n=t.options.right.mode),n}function o(t,i){var n=t.options.theme;return i===e.EDITOR_LEFT&&null!==t.options.left.theme&&(n=t.options.left.theme),i===e.EDITOR_RIGHT&&null!==t.options.right.theme&&(n=t.options.right.theme),n}function r(t,i,n){var o,r,s,a,c,l,f=parseInt(i.target.getAttribute("data-diff-index"),10),d=t.diffs[f];n===e.LTR?(o=t.editors.left,r=t.editors.right,s=d.leftStartLine,a=d.leftEndLine,c=d.rightStartLine,l=d.rightEndLine):(o=t.editors.right,r=t.editors.left,s=d.rightStartLine,a=d.rightEndLine,c=d.leftStartLine,l=d.leftEndLine);for(var h="",u=s;u<a;u++)h+=g(o,u)+"\n";var p="";for(u=0;u<c;u++)p+=g(r,u)+"\n";var L="",E=r.ace.getSession().getLength();for(u=l;u<E;u++)L+=g(r,u),u<E-1&&(L+="\n");L=L.replace(/\s*$/,"");var m=r.ace.getSession().getScrollTop();r.ace.getSession().setValue(p+h+L),r.ace.getSession().setScrollTop(parseInt(m)),t.diff()}function s(t){var e=t.ace.getSession().doc.getAllLines(),i=[];return e.forEach(function(t){i.push(t.length+1)}),i}function a(e,i,n,o,r){o<n&&(o=n);var s=r+" "+(o>n?"lines":"targetOnly");o--,(i=e.editors[i]).markers.push(i.ace.session.addMarker(new t(n,0,o,1),s,"fullLine"))}function c(t,e,i){var n,o,r;l(t),S(t),o=(n=t).editors.left.ace.getSession().getScrollTop(),r=n.editors.right.ace.getSession().getScrollTop(),n.copyRightContainer.style.cssText="top: "+-o+"px",n.copyLeftContainer.style.cssText="top: "+-r+"px"}function l(t){t.editors.left.markers.forEach(function(t){this.editors.left.ace.getSession().removeMarker(t)},t),t.editors.right.markers.forEach(function(t){this.editors.right.ace.getSession().removeMarker(t)},t)}function f(t,i,n,o,r){var s={},a=/^\n/.test(r);if(i===e.DIFF_INSERT){var c=d(t.editors.left,n,r),l=u(t.editors.right,o),f=h(t.editors.right,l),g=h(t.editors.left,c.startLine),L=l;0===h(t.editors.left,c.startLine)&&a&&(a=!1),0===c.startChar&&p(t.editors.right,o,a)&&(L=l+1);var E=c.startLine===c.endLine,m=0;(c.startChar>0||E&&r.length<g)&&f>0&&c.startChar<g&&m++,s={leftStartLine:c.startLine,leftEndLine:c.endLine+1,rightStartLine:L,rightEndLine:L+m}}else{c=d(t.editors.right,o,r),l=u(t.editors.left,n),f=h(t.editors.left,l);var S=h(t.editors.right,c.startLine),C=l;0===h(t.editors.right,c.startLine)&&a&&(a=!1),0===c.startChar&&p(t.editors.left,n,a)&&(C=l+1);E=c.startLine===c.endLine,m=0;(c.startChar>0||E&&r.length<S)&&f>0&&c.startChar<S&&m++,s={leftStartLine:C,leftEndLine:C+m,rightStartLine:c.startLine,rightEndLine:c.endLine+1}}return s}function d(t,e,i){var n={startLine:0,startChar:0,endLine:0,endChar:0},o=e+i.length,r=0,s=!1,a=!1;t.lineLengths.forEach(function(t,i){r+=t,!s&&e<r&&(n.startLine=i,n.startChar=e-r+t,s=!0),!a&&o<=r&&(n.endLine=i,n.endChar=o-r+t,a=!0)}),n.startChar>0&&h(t,n.startLine)===n.startChar&&(n.startLine++,n.startChar=0),0===n.endChar&&n.endLine--;var c=/\n$/.test(i);return n.startChar>0&&c&&n.endLine++,n}function h(t,e){return g(t,e).length}function g(t,e){return t.ace.getSession().doc.getLine(e)}function u(t,e){for(var i=t.ace.getSession().doc.getAllLines(),n=0,o=0,r=0;r<i.length;r++)if(e<=(o+=i[r].length+1)){n=r;break}return n}function p(t,e,i){for(var n=t.ace.getSession().doc.getAllLines(),o=0,r=!1,s=0;s<n.length;s++){var a=o+=n[s].length+1;if(i&&a--,e===a){r=!0;break}}return r}function L(t){var e=document.createElement("div"),i={class:t.className,style:"top:"+t.topOffset+"px",title:t.tooltip,"data-diff-index":t.diffIndex};for(var n in i)e.setAttribute(n,i[n]);return e.innerHTML=t.arrowContent,e}function E(t){t.gutterHeight=document.getElementById(t.options.classes.gutterID).clientHeight,t.gutterWidth=document.getElementById(t.options.classes.gutterID).clientWidth;var i=m(t,e.EDITOR_LEFT),n=m(t,e.EDITOR_RIGHT),o=Math.max(i,n,t.gutterHeight);t.gutterSVG=document.createElementNS(e.SVG_NS,"svg"),t.gutterSVG.setAttribute("width",t.gutterWidth),t.gutterSVG.setAttribute("height",o),document.getElementById(t.options.classes.gutterID).appendChild(t.gutterSVG)}function m(t,i){return(i===e.EDITOR_LEFT?t.editors.left:t.editors.right).ace.getSession().getLength()*t.lineHeight}function S(t){var i,n;i=t,document.getElementById(i.options.classes.gutterID).removeChild(i.gutterSVG),E(i),(n=t).copyLeftContainer.innerHTML="",n.copyRightContainer.innerHTML="",t.diffs.forEach(function(t,i){this.options.showDiffs&&(a(this,e.EDITOR_LEFT,t.leftStartLine,t.leftEndLine,this.options.classes.diff),a(this,e.EDITOR_RIGHT,t.rightStartLine,t.rightEndLine,this.options.classes.diff),this.options.showConnectors&&function(t,i,n,o,r){var s=t.editors.left.ace.getSession().getScrollTop(),a=t.editors.right.ace.getSession().getScrollTop();t.connectorYOffset=1;var c=i*t.lineHeight-s,l=t.gutterWidth+1,f=o*t.lineHeight-a,d=n*t.lineHeight-s+t.connectorYOffset,h=t.gutterWidth+1,g=r*t.lineHeight-a+t.connectorYOffset,u=y(-1,c,l,f)+" L"+l+","+f+" "+h+","+g+" "+y(h,g,-1,d)+" L-1,"+d+" "+-1+","+c,p=document.createElementNS(e.SVG_NS,"path");p.setAttribute("d",u),p.setAttribute("class",t.options.classes.connector),t.gutterSVG.appendChild(p)}(this,t.leftStartLine,t.leftEndLine,t.rightStartLine,t.rightEndLine),function(t,e,i){if(e.leftEndLine>e.leftStartLine&&t.options.left.copyLinkEnabled){var n=L({className:t.options.classes.newCodeConnectorLink,topOffset:e.leftStartLine*t.lineHeight,tooltip:"Copy to right",diffIndex:i,arrowContent:t.options.classes.newCodeConnectorLinkContent});t.copyRightContainer.appendChild(n)}e.rightEndLine>e.rightStartLine&&t.options.right.copyLinkEnabled&&(n=L({className:t.options.classes.deletedCodeConnectorLink,topOffset:e.rightStartLine*t.lineHeight,tooltip:"Copy to left",diffIndex:i,arrowContent:t.options.classes.deletedCodeConnectorLinkContent}),t.copyLeftContainer.appendChild(n))}(this,t,i))},t)}function C(){var t,e,i,n,o,r,s=arguments[0]||{},a=1,c=arguments.length,l=!1,f=Object.prototype.toString,d=Object.prototype.hasOwnProperty,h={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},g={isFunction:function(t){return"function"===g.type(t)},isArray:Array.isArray||function(t){return"array"===g.type(t)},isWindow:function(t){return null!==t&&t===t.window},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},type:function(t){return null===t?String(t):h[f.call(t)]||"object"},isPlainObject:function(t){if(!t||"object"!==g.type(t)||t.nodeType)return!1;try{if(t.constructor&&!d.call(t,"constructor")&&!d.call(t.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var e;for(e in t);return void 0===e||d.call(t,e)}};for("boolean"==typeof s&&(l=s,s=arguments[1]||{},a=2),"object"==typeof s||g.isFunction(s)||(s={}),c===a&&(s=this,--a);a<c;a++)if(null!==(t=arguments[a]))for(e in t)i=s[e],s!==(n=t[e])&&(l&&n&&(g.isPlainObject(n)||(o=g.isArray(n)))?(o?(o=!1,r=i&&g.isArray(i)?i:[]):r=i&&g.isPlainObject(i)?i:{},s[e]=C(l,r,n)):void 0!==n&&(s[e]=n));return s}function y(t,e,i,n){var o=t+(i-t)/2;return"M "+t+" "+e+" C "+o+","+e+" "+o+","+n+" "+i+","+n}function I(t,e,i,n){var o="document"===t?document:document.querySelector(t);o.addEventListener(e,function(t){for(var e=o.querySelectorAll(i),r=t.target,s=0,a=e.length;s<a;s++)for(var c=r,l=e[s];c&&c!==o;){if(c===l)return n.call(l,t);c=c.parentNode}})}return i.prototype={setOptions:function(t){C(!0,this.options,t),this.diff()},getNumDiffs:function(){return this.diffs.length},getEditors:function(){return{left:this.editors.left.ace,right:this.editors.right.ace}},diff:function(){var t=new diff_match_patch,i=this.editors.left.ace.getSession().getValue(),n=this.editors.right.ace.getSession().getValue(),o=t.diff_main(n,i);t.diff_cleanupSemantic(o),this.editors.left.lineLengths=s(this.editors.left),this.editors.right.lineLengths=s(this.editors.right);var r=[],a={left:0,right:0};o.forEach(function(t){var i=t[0],n=t[1];0!==n.length&&(i===e.DIFF_EQUAL?(a.left+=n.length,a.right+=n.length):i===e.DIFF_DELETE?(r.push(f(this,e.DIFF_DELETE,a.left,a.right,n)),a.right+=n.length):i===e.DIFF_INSERT&&(r.push(f(this,e.DIFF_INSERT,a.left,a.right,n)),a.left+=n.length))},this),this.diffs=function(t,i){var n=[];function o(i){return t.options.diffGranularity===e.DIFF_GRANULARITY_SPECIFIC?i<1:i<=1}i.forEach(function(t,e){if(0!==e){for(var i=!1,r=0;r<n.length;r++)if(o(Math.abs(t.leftStartLine-n[r].leftEndLine))&&o(Math.abs(t.rightStartLine-n[r].rightEndLine))){n[r].leftStartLine=Math.min(t.leftStartLine,n[r].leftStartLine),n[r].rightStartLine=Math.min(t.rightStartLine,n[r].rightStartLine),n[r].leftEndLine=Math.max(t.leftEndLine,n[r].leftEndLine),n[r].rightEndLine=Math.max(t.rightEndLine,n[r].rightEndLine),i=!0;break}i||n.push(t)}else n.push(t)});var r=[];return n.forEach(function(t){t.leftStartLine===t.leftEndLine&&t.rightStartLine===t.rightEndLine||r.push(t)}),r}(this,r),this.diffs.length>this.options.maxDiffs||(l(this),S(this))},destroy:function(){var t=this.editors.left.ace.getValue();this.editors.left.ace.destroy();var e=this.editors.left.ace.container,i=e.cloneNode(!1);i.textContent=t,e.parentNode.replaceChild(i,e);var n=this.editors.right.ace.getValue();this.editors.right.ace.destroy(),(i=(e=this.editors.right.ace.container).cloneNode(!1)).textContent=n,e.parentNode.replaceChild(i,e),document.getElementById(this.options.classes.gutterID).innerHTML=""}},i});